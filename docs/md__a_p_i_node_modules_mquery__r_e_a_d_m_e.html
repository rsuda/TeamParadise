<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Team Paradise: mquery</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Team Paradise
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">mquery </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><code>mquery</code> is a fluent mongodb query builder designed to run in multiple environments.</p>
<p><a href="https://travis-ci.org/aheckmann/mquery"><img src="https://travis-ci.org/aheckmann/mquery.svg?branch=master" alt="Build Status" style="pointer-events: none;" class="inline"/></a> <a href="http://badge.fury.io/js/mquery"><img src="https://badge.fury.io/js/mquery.svg" alt="NPM version" style="pointer-events: none;" class="inline"/></a></p>
<p><a href="https://www.npmjs.com/package/mquery"><img src="https://nodei.co/npm/mquery.png" alt="npm" class="inline"/></a></p>
<h1><a class="anchor" id="autotoc_md2685"></a>
Features</h1>
<ul>
<li>fluent query builder api</li>
<li>custom base query support</li>
<li>MongoDB 2.4 geoJSON support</li>
<li>method + option combinations validation</li>
<li>node.js driver compatibility</li>
<li>environment detection</li>
<li><a href="https://github.com/visionmedia/debug">debug</a> support</li>
<li>separated collection implementations for maximum flexibility</li>
</ul>
<h1><a class="anchor" id="autotoc_md2686"></a>
Use</h1>
<div class="fragment"><div class="line">require(&#39;mongodb&#39;).connect(uri, function (err, db) {</div>
<div class="line">  if (err) return handleError(err);</div>
<div class="line"> </div>
<div class="line">  // get a collection</div>
<div class="line">  var collection = db.collection(&#39;artists&#39;);</div>
<div class="line"> </div>
<div class="line">  // pass it to the constructor</div>
<div class="line">  mquery(collection).find({..}, callback);</div>
<div class="line"> </div>
<div class="line">  // or pass it to the collection method</div>
<div class="line">  mquery().find({..}).collection(collection).exec(callback)</div>
<div class="line"> </div>
<div class="line">  // or better yet, create a custom query constructor that has it always set</div>
<div class="line">  var Artist = mquery(collection).toConstructor();</div>
<div class="line">  Artist().find(..).where(..).exec(callback)</div>
<div class="line">})</div>
</div><!-- fragment --><p><code>mquery</code> requires a collection object to work with. In the example above we just pass the collection object created using the official <a href="https://github.com/mongodb/node-mongodb-native">MongoDB driver</a>.</p>
<h1><a class="anchor" id="autotoc_md2687"></a>
Fluent API</h1>
<ul>
<li><a href="#find">find</a></li>
<li><a href="#findOne">findOne</a></li>
<li><a href="#count">count</a></li>
<li><a href="#remove">remove</a></li>
<li><a href="#update">update</a></li>
<li><a href="#findoneandupdate">findOneAndUpdate</a></li>
<li><a href="#findoneandremove">findOneAndDelete, findOneAndRemove</a></li>
<li><a href="#distinct">distinct</a></li>
<li><a href="#exec">exec</a></li>
<li><a href="#stream">stream</a></li>
<li><a href="#all">all</a></li>
<li><a href="#and">and</a></li>
<li><a href="#box">box</a></li>
<li><a href="#circle">circle</a></li>
<li><a href="#elemmatch">elemMatch</a></li>
<li><a href="#equals">equals</a></li>
<li><a href="#exists">exists</a></li>
<li><a href="#geometry">geometry</a></li>
<li><a href="#gt">gt</a></li>
<li><a href="#gte">gte</a></li>
<li><a href="#in">in</a></li>
<li><a href="#intersects">intersects</a></li>
<li><a href="#lt">lt</a></li>
<li><a href="#lte">lte</a></li>
<li><a href="#maxdistance">maxDistance</a></li>
<li><a href="#mod">mod</a></li>
<li><a href="#ne">ne</a></li>
<li><a href="#nin">nin</a></li>
<li><a href="#nor">nor</a></li>
<li><a href="#near">near</a></li>
<li><a href="#or">or</a></li>
<li><a href="#polygon">polygon</a></li>
<li><a href="#regex">regex</a></li>
<li><a href="#select">select</a></li>
<li><a href="#selected">selected</a></li>
<li><a href="#selectedinclusively">selectedInclusively</a></li>
<li><a href="#selectedexclusively">selectedExclusively</a></li>
<li><a href="#size">size</a></li>
<li><a href="#slice">slice</a></li>
<li><a href="#within">within</a></li>
<li><a href="#where">where</a></li>
<li><a href="#where-1">$where</a></li>
<li><a href="#batchsize">batchSize</a></li>
<li><a href="#collation">collation</a></li>
<li><a href="#comment">comment</a></li>
<li><a href="#hint">hint</a></li>
<li><a href="#j">j</a></li>
<li><a href="#limit">limit</a></li>
<li><a href="#maxscan">maxScan</a></li>
<li><a href="#maxtime">maxTime, maxTimeMS</a></li>
<li><a href="#skip">skip</a></li>
<li><a href="#sort">sort</a></li>
<li><a href="#read">read, setReadPreference</a></li>
<li><a href="#readconcern">readConcern, r</a></li>
<li><a href="#slaveok">slaveOk</a></li>
<li><a href="#snapshot">snapshot</a></li>
<li><a href="#tailable">tailable</a></li>
<li><a href="#writeconcern">writeConcern, w</a></li>
<li><a href="#wtimeout">wtimeout, wTimeout</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md2688"></a>
Helpers</h1>
<ul>
<li><a href="#collection">collection</a></li>
<li><a href="#then">then</a></li>
<li><a href="#thunk">thunk</a></li>
<li><a href="#mergeobject">merge</a></li>
<li><a href="#setoptionsoptions">setOptions</a></li>
<li><a href="#settracefunctionfunc">setTraceFunction</a></li>
<li><a href="#mquerysetglobaltracefunctionfunc">mquery.setGlobalTraceFunction</a></li>
<li><a href="#mquerycanmerge">mquery.canMerge</a></li>
<li><a href="#mqueryusegeowithin">mquery.use$geoWithin</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md2689"></a>
find()</h2>
<p>Declares this query a <em>find</em> query. Optionally pass a match clause and / or callback. If a callback is passed the query is executed.</p>
<div class="fragment"><div class="line">mquery().find()</div>
<div class="line">mquery().find(match)</div>
<div class="line">mquery().find(callback)</div>
<div class="line">mquery().find(match, function (err, docs) {</div>
<div class="line">  assert(Array.isArray(docs));</div>
<div class="line">})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2690"></a>
findOne()</h2>
<p>Declares this query a <em>findOne</em> query. Optionally pass a match clause and / or callback. If a callback is passed the query is executed.</p>
<div class="fragment"><div class="line">mquery().findOne()</div>
<div class="line">mquery().findOne(match)</div>
<div class="line">mquery().findOne(callback)</div>
<div class="line">mquery().findOne(match, function (err, doc) {</div>
<div class="line">  if (doc) {</div>
<div class="line">    // the document may not be found</div>
<div class="line">    console.log(doc);</div>
<div class="line">  }</div>
<div class="line">})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2691"></a>
count()</h2>
<p>Declares this query a <em>count</em> query. Optionally pass a match clause and / or callback. If a callback is passed the query is executed.</p>
<div class="fragment"><div class="line">mquery().count()</div>
<div class="line">mquery().count(match)</div>
<div class="line">mquery().count(callback)</div>
<div class="line">mquery().count(match, function (err, number){</div>
<div class="line">  console.log(&#39;we found %d matching documents&#39;, number);</div>
<div class="line">})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2692"></a>
remove()</h2>
<p>Declares this query a <em>remove</em> query. Optionally pass a match clause and / or callback. If a callback is passed the query is executed.</p>
<div class="fragment"><div class="line">mquery().remove()</div>
<div class="line">mquery().remove(match)</div>
<div class="line">mquery().remove(callback)</div>
<div class="line">mquery().remove(match, function (err){})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2693"></a>
update()</h2>
<p>Declares this query an <em>update</em> query. Optionally pass an update document, match clause, options or callback. If a callback is passed, the query is executed. To force execution without passing a callback, run <code>update(true)</code>.</p>
<div class="fragment"><div class="line">mquery().update()</div>
<div class="line">mquery().update(match, updateDocument)</div>
<div class="line">mquery().update(match, updateDocument, options)</div>
<div class="line"> </div>
<div class="line">// the following all execute the command</div>
<div class="line">mquery().update(callback)</div>
<div class="line">mquery().update({$set: updateDocument, callback)</div>
<div class="line">mquery().update(match, updateDocument, callback)</div>
<div class="line">mquery().update(match, updateDocument, options, function (err, result){})</div>
<div class="line">mquery().update(true) // executes (unsafe write)</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md2694"></a>
the update document</h4>
<p>All paths passed that are not <code>$atomic</code> operations will become <code>$set</code> ops. For example:</p>
<div class="fragment"><div class="line">mquery(collection).where({ _id: id }).update({ title: &#39;words&#39; }, callback)</div>
</div><!-- fragment --><p>becomes</p>
<div class="fragment"><div class="line">collection.update({ _id: id }, { $set: { title: &#39;words&#39; }}, callback)</div>
</div><!-- fragment --><p>This behavior can be overridden using the <code>overwrite</code> option (see below).</p>
<h4><a class="anchor" id="autotoc_md2695"></a>
options</h4>
<p>Options are passed to the <code>setOptions()</code> method.</p>
<ul>
<li>overwrite</li>
</ul>
<p>Passing an empty object <code>{ }</code> as the update document will result in a no-op unless the <code>overwrite</code> option is passed. Without the <code>overwrite</code> option, the update operation will be ignored and the callback executed without sending the command to MongoDB to prevent accidently overwritting documents in the collection.</p>
<div class="fragment"><div class="line">var q = mquery(collection).where({ _id: id }).setOptions({ overwrite: true });</div>
<div class="line">q.update({ }, callback); // overwrite with an empty doc</div>
</div><!-- fragment --><p>The <code>overwrite</code> option isn't just for empty objects, it also provides a means to override the default <code>$set</code> conversion and send the update document as is.</p>
<div class="fragment"><div class="line">// create a base query</div>
<div class="line">var base = mquery({ _id: 108 }).collection(collection).toConstructor();</div>
<div class="line"> </div>
<div class="line">base().findOne(function (err, doc) {</div>
<div class="line">  console.log(doc); // { _id: 108, name: &#39;cajon&#39; })</div>
<div class="line"> </div>
<div class="line">  base().setOptions({ overwrite: true }).update({ changed: true }, function (err) {</div>
<div class="line">    base.findOne(function (err, doc) {</div>
<div class="line">      console.log(doc); // { _id: 108, changed: true }) - the doc was overwritten</div>
<div class="line">    });</div>
<div class="line">  });</div>
<div class="line">})</div>
</div><!-- fragment --><ul>
<li>multi</li>
</ul>
<p>Updates only modify a single document by default. To update multiple documents, set the <code>multi</code> option to <code>true</code>.</p>
<div class="fragment"><div class="line">mquery()</div>
<div class="line">  .collection(coll)</div>
<div class="line">  .update({ name: /^match/ }, { $addToSet: { arr: 4 }}, { multi: true }, callback)</div>
<div class="line"> </div>
<div class="line">// another way of doing it</div>
<div class="line">mquery({ name: /^match/ })</div>
<div class="line">  .collection(coll)</div>
<div class="line">  .setOptions({ multi: true })</div>
<div class="line">  .update({ $addToSet: { arr: 4 }}, callback)</div>
<div class="line"> </div>
<div class="line">// update multiple documents with an empty doc</div>
<div class="line">var q = mquery(collection).where({ name: /^match/ });</div>
<div class="line">q.setOptions({ multi: true, overwrite: true })</div>
<div class="line">q.update({ });</div>
<div class="line">q.update(function (err, result) {</div>
<div class="line">  console.log(arguments);</div>
<div class="line">});</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2696"></a>
findOneAndUpdate()</h2>
<p>Declares this query a <em>findAndModify</em> with update query. Optionally pass a match clause, update document, options, or callback. If a callback is passed, the query is executed.</p>
<p>When executed, the first matching document (if found) is modified according to the update document and passed back to the callback.</p>
<h4><a class="anchor" id="autotoc_md2697"></a>
options</h4>
<p>Options are passed to the <code>setOptions()</code> method.</p>
<ul>
<li><code>new</code>: boolean - true to return the modified document rather than the original. defaults to true</li>
<li><code>upsert</code>: boolean - creates the object if it doesn't exist. defaults to false</li>
<li><code>sort</code>: if multiple docs are found by the match condition, sets the sort order to choose which doc to update</li>
</ul>
<div class="fragment"><div class="line">query.findOneAndUpdate()</div>
<div class="line">query.findOneAndUpdate(updateDocument)</div>
<div class="line">query.findOneAndUpdate(match, updateDocument)</div>
<div class="line">query.findOneAndUpdate(match, updateDocument, options)</div>
<div class="line"> </div>
<div class="line">// the following all execute the command</div>
<div class="line">query.findOneAndUpdate(callback)</div>
<div class="line">query.findOneAndUpdate(updateDocument, callback)</div>
<div class="line">query.findOneAndUpdate(match, updateDocument, callback)</div>
<div class="line">query.findOneAndUpdate(match, updateDocument, options, function (err, doc) {</div>
<div class="line">  if (doc) {</div>
<div class="line">    // the document may not be found</div>
<div class="line">    console.log(doc);</div>
<div class="line">  }</div>
<div class="line">})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2698"></a>
findOneAndRemove()</h2>
<p>Declares this query a <em>findAndModify</em> with remove query. Alias of findOneAndDelete. Optionally pass a match clause, options, or callback. If a callback is passed, the query is executed.</p>
<p>When executed, the first matching document (if found) is modified according to the update document, removed from the collection and passed to the callback.</p>
<h4><a class="anchor" id="autotoc_md2699"></a>
options</h4>
<p>Options are passed to the <code>setOptions()</code> method.</p>
<ul>
<li><code>sort</code>: if multiple docs are found by the condition, sets the sort order to choose which doc to modify and remove</li>
</ul>
<div class="fragment"><div class="line">A.where().findOneAndDelete()</div>
<div class="line">A.where().findOneAndRemove()</div>
<div class="line">A.where().findOneAndRemove(match)</div>
<div class="line">A.where().findOneAndRemove(match, options)</div>
<div class="line"> </div>
<div class="line">// the following all execute the command</div>
<div class="line">A.where().findOneAndRemove(callback)</div>
<div class="line">A.where().findOneAndRemove(match, callback)</div>
<div class="line">A.where().findOneAndRemove(match, options, function (err, doc) {</div>
<div class="line">  if (doc) {</div>
<div class="line">    // the document may not be found</div>
<div class="line">    console.log(doc);</div>
<div class="line">  }</div>
<div class="line">})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2700"></a>
distinct()</h2>
<p>Declares this query a <em>distinct</em> query. Optionally pass the distinct field, a match clause or callback. If a callback is passed the query is executed.</p>
<div class="fragment"><div class="line">mquery().distinct()</div>
<div class="line">mquery().distinct(match)</div>
<div class="line">mquery().distinct(match, field)</div>
<div class="line">mquery().distinct(field)</div>
<div class="line"> </div>
<div class="line">// the following all execute the command</div>
<div class="line">mquery().distinct(callback)</div>
<div class="line">mquery().distinct(field, callback)</div>
<div class="line">mquery().distinct(match, callback)</div>
<div class="line">mquery().distinct(match, field, function (err, result) {</div>
<div class="line">  console.log(result);</div>
<div class="line">})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2701"></a>
exec()</h2>
<p>Executes the query.</p>
<div class="fragment"><div class="line">mquery().findOne().where(&#39;route&#39;).intersects(polygon).exec(function (err, docs){})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2702"></a>
stream()</h2>
<p>Executes the query and returns a stream.</p>
<div class="fragment"><div class="line">var stream = mquery().find().stream(options);</div>
<div class="line">stream.on(&#39;data&#39;, cb);</div>
<div class="line">stream.on(&#39;close&#39;, fn);</div>
</div><!-- fragment --><p>Note: this only works with <code>find()</code> operations.</p>
<p>Note: returns the stream object directly from the node-mongodb-native driver. (currently streams1 type stream). Any options will be passed along to the <a href="http://mongodb.github.io/node-mongodb-native/api-generated/cursor.html#stream">driver method</a>.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md2704"></a>
all()</h2>
<p>Specifies an <code>$all</code> query condition</p>
<div class="fragment"><div class="line">mquery().where(&#39;permission&#39;).all([&#39;read&#39;, &#39;write&#39;])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/all/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2705"></a>
and()</h2>
<p>Specifies arguments for an <code>$and</code> condition</p>
<div class="fragment"><div class="line">mquery().and([{ color: &#39;green&#39; }, { status: &#39;ok&#39; }])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/and/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2706"></a>
box()</h2>
<p>Specifies a <code>$box</code> condition</p>
<div class="fragment"><div class="line">var lowerLeft = [40.73083, -73.99756]</div>
<div class="line">var upperRight= [40.741404,  -73.988135]</div>
<div class="line"> </div>
<div class="line">mquery().where(&#39;location&#39;).within().box(lowerLeft, upperRight)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/box/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2707"></a>
circle()</h2>
<p>Specifies a <code>$center</code> or <code>$centerSphere</code> condition.</p>
<div class="fragment"><div class="line">var area = { center: [50, 50], radius: 10, unique: true }</div>
<div class="line">query.where(&#39;loc&#39;).within().circle(area)</div>
<div class="line">query.circle(&#39;loc&#39;, area);</div>
<div class="line"> </div>
<div class="line">// for spherical calculations</div>
<div class="line">var area = { center: [50, 50], radius: 10, unique: true, spherical: true }</div>
<div class="line">query.where(&#39;loc&#39;).within().circle(area)</div>
<div class="line">query.circle(&#39;loc&#39;, area);</div>
</div><!-- fragment --><ul>
<li><a href="http://docs.mongodb.org/manual/reference/operator/center/">MongoDB Documentation - center</a></li>
<li><a href="http://docs.mongodb.org/manual/reference/operator/centerSphere/">MongoDB Documentation - centerSphere</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md2708"></a>
elemMatch()</h2>
<p>Specifies an <code>$elemMatch</code> condition</p>
<div class="fragment"><div class="line">query.where(&#39;comment&#39;).elemMatch({ author: &#39;autobot&#39;, votes: {$gte: 5}})</div>
<div class="line"> </div>
<div class="line">query.elemMatch(&#39;comment&#39;, function (elem) {</div>
<div class="line">  elem.where(&#39;author&#39;).equals(&#39;autobot&#39;);</div>
<div class="line">  elem.where(&#39;votes&#39;).gte(5);</div>
<div class="line">})</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/elemMatch/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2709"></a>
equals()</h2>
<p>Specifies the complementary comparison value for the path specified with <code>where()</code>.</p>
<div class="fragment"><div class="line">mquery().where(&#39;age&#39;).equals(49);</div>
<div class="line"> </div>
<div class="line">// is the same as</div>
<div class="line"> </div>
<div class="line">mquery().where({ &#39;age&#39;: 49 });</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2710"></a>
exists()</h2>
<p>Specifies an <code>$exists</code> condition</p>
<div class="fragment"><div class="line">// { name: { $exists: true }}</div>
<div class="line">mquery().where(&#39;name&#39;).exists()</div>
<div class="line">mquery().where(&#39;name&#39;).exists(true)</div>
<div class="line">mquery().exists(&#39;name&#39;)</div>
<div class="line"> </div>
<div class="line">// { name: { $exists: false }}</div>
<div class="line">mquery().where(&#39;name&#39;).exists(false);</div>
<div class="line">mquery().exists(&#39;name&#39;, false);</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/exists/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2711"></a>
geometry()</h2>
<p>Specifies a <code>$geometry</code> condition</p>
<div class="fragment"><div class="line">var polyA = [[[ 10, 20 ], [ 10, 40 ], [ 30, 40 ], [ 30, 20 ]]]</div>
<div class="line">query.where(&#39;loc&#39;).within().geometry({ type: &#39;Polygon&#39;, coordinates: polyA })</div>
<div class="line"> </div>
<div class="line">// or</div>
<div class="line">var polyB = [[ 0, 0 ], [ 1, 1 ]]</div>
<div class="line">query.where(&#39;loc&#39;).within().geometry({ type: &#39;LineString&#39;, coordinates: polyB })</div>
<div class="line"> </div>
<div class="line">// or</div>
<div class="line">var polyC = [ 0, 0 ]</div>
<div class="line">query.where(&#39;loc&#39;).within().geometry({ type: &#39;Point&#39;, coordinates: polyC })</div>
<div class="line"> </div>
<div class="line">// or</div>
<div class="line">query.where(&#39;loc&#39;).intersects().geometry({ type: &#39;Point&#39;, coordinates: polyC })</div>
<div class="line"> </div>
<div class="line">// or</div>
<div class="line">query.where(&#39;loc&#39;).near().geometry({ type: &#39;Point&#39;, coordinates: [3,5] })</div>
</div><!-- fragment --><p><code>geometry()</code> <b>must</b> come after <code>intersects()</code>, <code>within()</code>, or <code>near()</code>.</p>
<p>The <code>object</code> argument must contain <code>type</code> and <code>coordinates</code> properties.</p>
<ul>
<li>type <code>String</code></li>
<li>coordinates <code>Array</code></li>
</ul>
<p><a href="http://docs.mongodb.org/manual/reference/operator/geometry/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2712"></a>
gt()</h2>
<p>Specifies a <code>$gt</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;clicks&#39;).gt(999)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/gt/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2713"></a>
gte()</h2>
<p>Specifies a <code>$gte</code> query condition.</p>
<p><a href="http://docs.mongodb.org/manual/reference/operator/gte/">MongoDB Documentation</a></p>
<div class="fragment"><div class="line">mquery().where(&#39;clicks&#39;).gte(1000)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2714"></a>
in()</h2>
<p>Specifies an <code>$in</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;author_id&#39;).in([3, 48901, 761])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/in/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2715"></a>
intersects()</h2>
<p>Declares an <code>$geoIntersects</code> query for <code>geometry()</code>.</p>
<div class="fragment"><div class="line">query.where(&#39;path&#39;).intersects().geometry({</div>
<div class="line">    type: &#39;LineString&#39;</div>
<div class="line">  , coordinates: [[180.0, 11.0], [180, 9.0]]</div>
<div class="line">})</div>
<div class="line"> </div>
<div class="line">// geometry arguments are supported</div>
<div class="line">query.where(&#39;path&#39;).intersects({</div>
<div class="line">    type: &#39;LineString&#39;</div>
<div class="line">  , coordinates: [[180.0, 11.0], [180, 9.0]]</div>
<div class="line">})</div>
</div><!-- fragment --><p><b>Must</b> be used after <code>where()</code>.</p>
<p><a href="http://docs.mongodb.org/manual/reference/operator/geoIntersects/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2716"></a>
lt()</h2>
<p>Specifies a <code>$lt</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;clicks&#39;).lt(50)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/lt/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2717"></a>
lte()</h2>
<p>Specifies a <code>$lte</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;clicks&#39;).lte(49)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/lte/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2718"></a>
maxDistance()</h2>
<p>Specifies a <code>$maxDistance</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;location&#39;).near({ center: [139, 74.3] }).maxDistance(5)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/maxDistance/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2719"></a>
mod()</h2>
<p>Specifies a <code>$mod</code> condition</p>
<div class="fragment"><div class="line">mquery().where(&#39;count&#39;).mod(2, 0)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/mod/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2720"></a>
ne()</h2>
<p>Specifies a <code>$ne</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;status&#39;).ne(&#39;ok&#39;)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/ne/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2721"></a>
nin()</h2>
<p>Specifies an <code>$nin</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;author_id&#39;).nin([3, 48901, 761])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/nin/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2722"></a>
nor()</h2>
<p>Specifies arguments for an <code>$nor</code> condition.</p>
<div class="fragment"><div class="line">mquery().nor([{ color: &#39;green&#39; }, { status: &#39;ok&#39; }])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/nor/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2723"></a>
near()</h2>
<p>Specifies arguments for a <code>$near</code> or <code>$nearSphere</code> condition.</p>
<p>These operators return documents sorted by distance.</p>
<h3><a class="anchor" id="autotoc_md2724"></a>
Example</h3>
<div class="fragment"><div class="line">query.where(&#39;loc&#39;).near({ center: [10, 10] });</div>
<div class="line">query.where(&#39;loc&#39;).near({ center: [10, 10], maxDistance: 5 });</div>
<div class="line">query.near(&#39;loc&#39;, { center: [10, 10], maxDistance: 5 });</div>
<div class="line"> </div>
<div class="line">// GeoJSON</div>
<div class="line">query.where(&#39;loc&#39;).near({ center: { type: &#39;Point&#39;, coordinates: [10, 10] }});</div>
<div class="line">query.where(&#39;loc&#39;).near({ center: { type: &#39;Point&#39;, coordinates: [10, 10] }, maxDistance: 5, spherical: true });</div>
<div class="line">query.where(&#39;loc&#39;).near().geometry({ type: &#39;Point&#39;, coordinates: [10, 10] });</div>
<div class="line"> </div>
<div class="line">// For a $nearSphere condition, pass the `spherical` option.</div>
<div class="line">query.near({ center: [10, 10], maxDistance: 5, spherical: true });</div>
</div><!-- fragment --><p><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2725"></a>
or()</h2>
<p>Specifies arguments for an <code>$or</code> condition.</p>
<div class="fragment"><div class="line">mquery().or([{ color: &#39;red&#39; }, { status: &#39;emergency&#39; }])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/or/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2726"></a>
polygon()</h2>
<p>Specifies a <code>$polygon</code> condition</p>
<div class="fragment"><div class="line">mquery().where(&#39;loc&#39;).within().polygon([10,20], [13, 25], [7,15])</div>
<div class="line">mquery().polygon(&#39;loc&#39;, [10,20], [13, 25], [7,15])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/polygon/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2727"></a>
regex()</h2>
<p>Specifies a <code>$regex</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;name&#39;).regex(/^sixstepsrecords/)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/regex/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2728"></a>
select()</h2>
<p>Specifies which document fields to include or exclude</p>
<div class="fragment"><div class="line">// 1 means include, 0 means exclude</div>
<div class="line">mquery().select({ name: 1, address: 1, _id: 0 })</div>
<div class="line"> </div>
<div class="line">// or</div>
<div class="line"> </div>
<div class="line">mquery().select(&#39;name address -_id&#39;)</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md2729"></a>
String syntax</h4>
<p>When passing a string, prefixing a path with <code>-</code> will flag that path as excluded. When a path does not have the <code>-</code> prefix, it is included.</p>
<div class="fragment"><div class="line">// include a and b, exclude c</div>
<div class="line">query.select(&#39;a b -c&#39;);</div>
<div class="line"> </div>
<div class="line">// or you may use object notation, useful when</div>
<div class="line">// you have keys already prefixed with a &quot;-&quot;</div>
<div class="line">query.select({a: 1, b: 1, c: 0});</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<h2><a class="anchor" id="autotoc_md2730"></a>
selected()</h2>
<p>Determines if the query has selected any fields.</p>
<div class="fragment"><div class="line">var query = mquery();</div>
<div class="line">query.selected() // false</div>
<div class="line">query.select(&#39;-name&#39;);</div>
<div class="line">query.selected() // true</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2731"></a>
selectedInclusively()</h2>
<p>Determines if the query has selected any fields inclusively.</p>
<div class="fragment"><div class="line">var query = mquery().select(&#39;name&#39;);</div>
<div class="line">query.selectedInclusively() // true</div>
<div class="line"> </div>
<div class="line">var query = mquery();</div>
<div class="line">query.selected() // false</div>
<div class="line">query.select(&#39;-name&#39;);</div>
<div class="line">query.selectedInclusively() // false</div>
<div class="line">query.selectedExclusively() // true</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2732"></a>
selectedExclusively()</h2>
<p>Determines if the query has selected any fields exclusively.</p>
<div class="fragment"><div class="line">var query = mquery().select(&#39;-name&#39;);</div>
<div class="line">query.selectedExclusively() // true</div>
<div class="line"> </div>
<div class="line">var query = mquery();</div>
<div class="line">query.selected() // false</div>
<div class="line">query.select(&#39;name&#39;);</div>
<div class="line">query.selectedExclusively() // false</div>
<div class="line">query.selectedInclusively() // true</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2733"></a>
size()</h2>
<p>Specifies a <code>$size</code> query condition.</p>
<div class="fragment"><div class="line">mquery().where(&#39;someArray&#39;).size(6)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/operator/size/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2734"></a>
slice()</h2>
<p>Specifies a <code>$slice</code> projection for a <code>path</code></p>
<div class="fragment"><div class="line">mquery().where(&#39;comments&#39;).slice(5)</div>
<div class="line">mquery().where(&#39;comments&#39;).slice(-5)</div>
<div class="line">mquery().where(&#39;comments&#39;).slice([-10, 5])</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/projection/slice/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2735"></a>
within()</h2>
<p>Sets a <code>$geoWithin</code> or <code>$within</code> argument for geo-spatial queries.</p>
<div class="fragment"><div class="line">mquery().within().box()</div>
<div class="line">mquery().within().circle()</div>
<div class="line">mquery().within().geometry()</div>
<div class="line"> </div>
<div class="line">mquery().where(&#39;loc&#39;).within({ center: [50,50], radius: 10, unique: true, spherical: true });</div>
<div class="line">mquery().where(&#39;loc&#39;).within({ box: [[40.73, -73.9], [40.7, -73.988]] });</div>
<div class="line">mquery().where(&#39;loc&#39;).within({ polygon: [[],[],[],[]] });</div>
<div class="line"> </div>
<div class="line">mquery().where(&#39;loc&#39;).within([], [], []) // polygon</div>
<div class="line">mquery().where(&#39;loc&#39;).within([], []) // box</div>
<div class="line">mquery().where(&#39;loc&#39;).within({ type: &#39;LineString&#39;, coordinates: [...] }); // geometry</div>
</div><!-- fragment --><p>As of mquery 2.0, <code>$geoWithin</code> is used by default. This impacts you if running MongoDB &lt; 2.4. To alter this behavior, see <a href="#mqueryusegeowithin">mquery.use$geoWithin</a>.</p>
<p><b>Must</b> be used after <code>where()</code>.</p>
<p><a href="http://docs.mongodb.org/manual/reference/operator/geoWithin/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2736"></a>
where()</h2>
<p>Specifies a <code>path</code> for use with chaining</p>
<div class="fragment"><div class="line">// instead of writing:</div>
<div class="line">mquery().find({age: {$gte: 21, $lte: 65}});</div>
<div class="line"> </div>
<div class="line">// we can instead write:</div>
<div class="line">mquery().where(&#39;age&#39;).gte(21).lte(65);</div>
<div class="line"> </div>
<div class="line">// passing query conditions is permitted too</div>
<div class="line">mquery().find().where({ name: &#39;vonderful&#39; })</div>
<div class="line"> </div>
<div class="line">// chaining</div>
<div class="line">mquery()</div>
<div class="line">.where(&#39;age&#39;).gte(21).lte(65)</div>
<div class="line">.where({ &#39;name&#39;: /^vonderful/i })</div>
<div class="line">.where(&#39;friends&#39;).slice(10)</div>
<div class="line">.exec(callback)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2737"></a>
$where()</h2>
<p>Specifies a <code>$where</code> condition.</p>
<p>Use <code>$where</code> when you need to select documents using a JavaScript expression.</p>
<div class="fragment"><div class="line">query.$where(&#39;this.comments.length &gt; 10 || this.name.length &gt; 5&#39;).exec(callback)</div>
<div class="line"> </div>
<div class="line">query.$where(function () {</div>
<div class="line">  return this.comments.length &gt; 10 || this.name.length &gt; 5;</div>
<div class="line">})</div>
</div><!-- fragment --><p>Only use <code>$where</code> when you have a condition that cannot be met using other MongoDB operators like <code>$lt</code>. Be sure to read about all of <a href="http://docs.mongodb.org/manual/reference/operator/where/">its caveats</a> before using.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md2739"></a>
batchSize()</h2>
<p>Specifies the batchSize option.</p>
<div class="fragment"><div class="line">query.batchSize(100)</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/method/cursor.batchSize/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2740"></a>
collation()</h2>
<p>Specifies the collation option.</p>
<div class="fragment"><div class="line">query.collation({ locale: &quot;en_US&quot;, strength: 1 })</div>
</div><!-- fragment --><p><a href="https://docs.mongodb.com/manual/reference/method/cursor.collation/#cursor.collation">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2741"></a>
comment()</h2>
<p>Specifies the comment option.</p>
<div class="fragment"><div class="line">query.comment(&#39;login query&#39;);</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/operator/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2742"></a>
hint()</h2>
<p>Sets query hints.</p>
<div class="fragment"><div class="line">mquery().hint({ indexA: 1, indexB: -1 })</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/operator/hint/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2743"></a>
j()</h2>
<p>Requests acknowledgement that this operation has been persisted to MongoDB's on-disk journal.</p>
<p>This option is only valid for operations that write to the database:</p>
<ul>
<li><code>deleteOne()</code></li>
<li><code>deleteMany()</code></li>
<li><code>findOneAndDelete()</code></li>
<li><code>findOneAndUpdate()</code></li>
<li><code>remove()</code></li>
<li><code>update()</code></li>
<li><code>updateOne()</code></li>
<li><code>updateMany()</code></li>
</ul>
<p>Defaults to the <code>j</code> value if it is specified in <a href="#writeconcern">writeConcern</a></p>
<div class="fragment"><div class="line">mquery().j(true);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2744"></a>
limit()</h2>
<p>Specifies the limit option.</p>
<div class="fragment"><div class="line">query.limit(20)</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/method/cursor.limit/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2745"></a>
maxScan()</h2>
<p>Specifies the maxScan option.</p>
<div class="fragment"><div class="line">query.maxScan(100)</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/operator/maxScan/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2746"></a>
maxTime()</h2>
<p>Specifies the maxTimeMS option.</p>
<div class="fragment"><div class="line">query.maxTime(100)</div>
<div class="line">query.maxTimeMS(100)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/method/cursor.maxTimeMS/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2747"></a>
skip()</h2>
<p>Specifies the skip option.</p>
<div class="fragment"><div class="line">query.skip(100).limit(20)</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/method/cursor.skip/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2748"></a>
sort()</h2>
<p>Sets the query sort order.</p>
<p>If an object is passed, key values allowed are <code>asc</code>, <code>desc</code>, <code>ascending</code>, <code>descending</code>, <code>1</code>, and <code>-1</code>.</p>
<p>If a string is passed, it must be a space delimited list of path names. The sort order of each path is ascending unless the path name is prefixed with <code>-</code> which will be treated as descending.</p>
<div class="fragment"><div class="line">// these are equivalent</div>
<div class="line">query.sort({ field: &#39;asc&#39;, test: -1 });</div>
<div class="line">query.sort(&#39;field -test&#39;);</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/method/cursor.sort/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2749"></a>
read()</h2>
<p>Sets the readPreference option for the query.</p>
<div class="fragment"><div class="line">mquery().read(&#39;primary&#39;)</div>
<div class="line">mquery().read(&#39;p&#39;)  // same as primary</div>
<div class="line"> </div>
<div class="line">mquery().read(&#39;primaryPreferred&#39;)</div>
<div class="line">mquery().read(&#39;pp&#39;) // same as primaryPreferred</div>
<div class="line"> </div>
<div class="line">mquery().read(&#39;secondary&#39;)</div>
<div class="line">mquery().read(&#39;s&#39;)  // same as secondary</div>
<div class="line"> </div>
<div class="line">mquery().read(&#39;secondaryPreferred&#39;)</div>
<div class="line">mquery().read(&#39;sp&#39;) // same as secondaryPreferred</div>
<div class="line"> </div>
<div class="line">mquery().read(&#39;nearest&#39;)</div>
<div class="line">mquery().read(&#39;n&#39;)  // same as nearest</div>
<div class="line"> </div>
<div class="line">mquery().setReadPreference(&#39;primary&#39;) // alias of .read()</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md2750"></a>
Preferences:</h4>
<ul>
<li><code>primary</code> - (default) Read from primary only. Operations will produce an error if primary is unavailable. Cannot be combined with tags.</li>
<li><code>secondary</code> - Read from secondary if available, otherwise error.</li>
<li><code>primaryPreferred</code> - Read from primary if available, otherwise a secondary.</li>
<li><code>secondaryPreferred</code> - Read from a secondary if available, otherwise read from the primary.</li>
<li><code>nearest</code> - All operations read from among the nearest candidates, but unlike other modes, this option will include both the primary and all secondaries in the random selection.</li>
</ul>
<p>Aliases</p>
<ul>
<li><code>p</code> primary</li>
<li><code>pp</code> primaryPreferred</li>
<li><code>s</code> secondary</li>
<li><code>sp</code> secondaryPreferred</li>
<li><code>n</code> nearest</li>
</ul>
<h4><a class="anchor" id="autotoc_md2751"></a>
Preference Tags:</h4>
<p>To keep the separation of concerns between <code>mquery</code> and your driver clean, <code>mquery#read()</code> no longer handles specifying a second <code>tags</code> argument as of version 0.5. If you need to specify tags, pass any non-string argument as the first argument. <code>mquery</code> will pass this argument untouched to your collections methods later. For example:</p>
<div class="fragment"><div class="line">// example of specifying tags using the Node.js driver</div>
<div class="line">var ReadPref = require(&#39;mongodb&#39;).ReadPreference;</div>
<div class="line">var preference = new ReadPref(&#39;secondary&#39;, [{ dc:&#39;sf&#39;, s: 1 },{ dc:&#39;ma&#39;, s: 2 }]);</div>
<div class="line">mquery(..).read(preference).exec();</div>
</div><!-- fragment --><p>Read more about how to use read preferences <a href="http://docs.mongodb.org/manual/applications/replication/#read-preference">here</a> and <a href="http://mongodb.github.com/node-mongodb-native/driver-articles/anintroductionto1_1and2_2.html#read-preferences">here</a>.</p>
<h2><a class="anchor" id="autotoc_md2752"></a>
readConcern()</h2>
<p>Sets the readConcern option for the query.</p>
<div class="fragment"><div class="line">// local</div>
<div class="line">mquery().readConcern(&#39;local&#39;)</div>
<div class="line">mquery().readConcern(&#39;l&#39;)</div>
<div class="line">mquery().r(&#39;l&#39;)</div>
<div class="line"> </div>
<div class="line">// available</div>
<div class="line">mquery().readConcern(&#39;available&#39;)</div>
<div class="line">mquery().readConcern(&#39;a&#39;)</div>
<div class="line">mquery().r(&#39;a&#39;)</div>
<div class="line"> </div>
<div class="line">// majority</div>
<div class="line">mquery().readConcern(&#39;majority&#39;)</div>
<div class="line">mquery().readConcern(&#39;m&#39;)</div>
<div class="line">mquery().r(&#39;m&#39;)</div>
<div class="line"> </div>
<div class="line">// linearizable</div>
<div class="line">mquery().readConcern(&#39;linearizable&#39;)</div>
<div class="line">mquery().readConcern(&#39;lz&#39;)</div>
<div class="line">mquery().r(&#39;lz&#39;)</div>
<div class="line"> </div>
<div class="line">// snapshot</div>
<div class="line">mquery().readConcern(&#39;snapshot&#39;)</div>
<div class="line">mquery().readConcern(&#39;s&#39;)</div>
<div class="line">mquery().r(&#39;s&#39;)</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md2753"></a>
Read Concern Level:</h4>
<ul>
<li><code>local</code> - The query returns from the instance with no guarantee guarantee that the data has been written to a majority of the replica set members (i.e. may be rolled back). (MongoDB 3.2+)</li>
<li><code>available</code> - The query returns from the instance with no guarantee guarantee that the data has been written to a majority of the replica set members (i.e. may be rolled back). (MongoDB 3.6+)</li>
<li><code>majority</code> - The query returns the data that has been acknowledged by a majority of the replica set members. The documents returned by the read operation are durable, even in the event of failure. (MongoDB 3.2+)</li>
<li><code>linearizable</code> - The query returns data that reflects all successful majority-acknowledged writes that completed prior to the start of the read operation. The query may wait for concurrently executing writes to propagate to a majority of replica set members before returning results. (MongoDB 3.4+)</li>
<li><code>snapshot</code> - Only available for operations within multi-document transactions. Upon transaction commit with write concern "majority", the transaction operations are guaranteed to have read from a snapshot of majority-committed data. (MongoDB 4.0+)</li>
</ul>
<p>Aliases</p>
<ul>
<li><code>l</code> local</li>
<li><code>a</code> available</li>
<li><code>m</code> majority</li>
<li><code>lz</code> linearizable</li>
<li><code>s</code> snapshot</li>
</ul>
<p>Read more about how to use read concern <a href="https://docs.mongodb.com/manual/reference/read-concern/">here</a>.</p>
<h2><a class="anchor" id="autotoc_md2754"></a>
writeConcern()</h2>
<p>Sets the writeConcern option for the query.</p>
<p>This option is only valid for operations that write to the database:</p>
<ul>
<li><code>deleteOne()</code></li>
<li><code>deleteMany()</code></li>
<li><code>findOneAndDelete()</code></li>
<li><code>findOneAndUpdate()</code></li>
<li><code>remove()</code></li>
<li><code>update()</code></li>
<li><code>updateOne()</code></li>
<li><code>updateMany()</code></li>
</ul>
<div class="fragment"><div class="line">mquery().writeConcern(0)</div>
<div class="line">mquery().writeConcern(1)</div>
<div class="line">mquery().writeConcern({ w: 1, j: true, wtimeout: 2000 })</div>
<div class="line">mquery().writeConcern(&#39;majority&#39;)</div>
<div class="line">mquery().writeConcern(&#39;m&#39;) // same as majority</div>
<div class="line">mquery().writeConcern(&#39;tagSetName&#39;) // if the tag set is &#39;m&#39;, use .writeConcern({ w: &#39;m&#39; }) instead</div>
<div class="line">mquery().w(1) // w is alias of writeConcern</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md2755"></a>
Write Concern:</h4>
<p>writeConcern({ w: <code>&lt;value&gt;</code>, j: <code>&lt;boolean&gt;</code>, wtimeout: <code>&lt;number&gt;</code> }`)</p>
<ul>
<li>the w option to request acknowledgement that the write operation has propagated to a specified number of mongod instances or to mongod instances with specified tags</li>
<li>the j option to request acknowledgement that the write operation has been written to the journal</li>
<li>the wtimeout option to specify a time limit to prevent write operations from blocking indefinitely</li>
</ul>
<p>Can be break down to use the following syntax:</p>
<p>mquery().w(<code>&lt;value&gt;</code>).j(<code>&lt;boolean&gt;</code>).wtimeout(<code>&lt;number&gt;</code>)</p>
<p>Read more about how to use write concern <a href="https://docs.mongodb.com/manual/reference/write-concern/">here</a></p>
<h2><a class="anchor" id="autotoc_md2756"></a>
slaveOk()</h2>
<p>Sets the slaveOk option. <code>true</code> allows reading from secondaries.</p>
<p><b>deprecated</b> use <a href="#read">read()</a> preferences instead if on mongodb &gt;= 2.2</p>
<div class="fragment"><div class="line">query.slaveOk() // true</div>
<div class="line">query.slaveOk(true)</div>
<div class="line">query.slaveOk(false)</div>
</div><!-- fragment --><p><a href="http://docs.mongodb.org/manual/reference/method/rs.slaveOk/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2757"></a>
snapshot()</h2>
<p>Specifies this query as a snapshot query.</p>
<div class="fragment"><div class="line">mquery().snapshot() // true</div>
<div class="line">mquery().snapshot(true)</div>
<div class="line">mquery().snapshot(false)</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/reference/operator/snapshot/">MongoDB documentation</a></p>
<h2><a class="anchor" id="autotoc_md2758"></a>
tailable()</h2>
<p>Sets tailable option.</p>
<div class="fragment"><div class="line">mquery().tailable() &lt;== true</div>
<div class="line">mquery().tailable(true)</div>
<div class="line">mquery().tailable(false)</div>
</div><!-- fragment --><p><em>Cannot be used with <code>distinct()</code>.</em></p>
<p><a href="http://docs.mongodb.org/manual/tutorial/create-tailable-cursor/">MongoDB Documentation</a></p>
<h2><a class="anchor" id="autotoc_md2759"></a>
wtimeout()</h2>
<p>Specifies a time limit, in milliseconds, for the write concern. If <code>w &gt; 1</code>, it is maximum amount of time to wait for this write to propagate through the replica set before this operation fails. The default is <code>0</code>, which means no timeout.</p>
<p>This option is only valid for operations that write to the database:</p>
<ul>
<li><code>deleteOne()</code></li>
<li><code>deleteMany()</code></li>
<li><code>findOneAndDelete()</code></li>
<li><code>findOneAndUpdate()</code></li>
<li><code>remove()</code></li>
<li><code>update()</code></li>
<li><code>updateOne()</code></li>
<li><code>updateMany()</code></li>
</ul>
<p>Defaults to <code>wtimeout</code> value if it is specified in <a href="#writeconcern">writeConcern</a></p>
<div class="fragment"><div class="line">mquery().wtimeout(2000)</div>
<div class="line">mquery().wTimeout(2000)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2760"></a>
Helpers</h1>
<h2><a class="anchor" id="autotoc_md2761"></a>
collection()</h2>
<p>Sets the querys collection.</p>
<div class="fragment"><div class="line">mquery().collection(aCollection)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2762"></a>
then()</h2>
<p>Executes the query and returns a promise which will be resolved with the query results or rejected if the query responds with an error.</p>
<div class="fragment"><div class="line">mquery().find(..).then(success, error);</div>
</div><!-- fragment --><p>This is very useful when combined with <a href="https://github.com/visionmedia/co">co</a> or <a href="https://github.com/koajs/koa">koa</a>, which automatically resolve promise-like objects for you.</p>
<div class="fragment"><div class="line">co(function*(){</div>
<div class="line">  var doc = yield mquery().findOne({ _id: 499 });</div>
<div class="line">  console.log(doc); // { _id: 499, name: &#39;amazing&#39;, .. }</div>
<div class="line">})();</div>
</div><!-- fragment --><p><em>NOTE</em>: The returned promise is a <a href="https://github.com/petkaantonov/bluebird/">bluebird</a> promise but this is customizable. If you want to use your favorite promise library, simply set <code>mquery.Promise = YourPromiseConstructor</code>. Your <code>Promise</code> must be <a href="http://promisesaplus.com/">promises A+</a> compliant.</p>
<h2><a class="anchor" id="autotoc_md2763"></a>
thunk()</h2>
<p>Returns a thunk which when called runs the query's <code>exec</code> method passing the results to the callback.</p>
<div class="fragment"><div class="line">var thunk = mquery(collection).find({..}).thunk();</div>
<div class="line"> </div>
<div class="line">thunk(function(err, results) {</div>
<div class="line"> </div>
<div class="line">})</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2764"></a>
merge(object)</h2>
<p>Merges other mquery or match condition objects into this one. When an mquery instance is passed, its match conditions, field selection and options are merged.</p>
<div class="fragment"><div class="line">var drum = mquery({ type: &#39;drum&#39; }).collection(instruments);</div>
<div class="line">var redDrum = mquery({ color: &#39;red&#39; }).merge(drum);</div>
<div class="line">redDrum.count(function (err, n) {</div>
<div class="line">  console.log(&#39;there are %d red drums&#39;, n);</div>
<div class="line">})</div>
</div><!-- fragment --><p>Internally uses <code>mquery.canMerge</code> to determine validity.</p>
<h2><a class="anchor" id="autotoc_md2765"></a>
setOptions(options)</h2>
<p>Sets query options.</p>
<div class="fragment"><div class="line">mquery().setOptions({ collection: coll, limit: 20 })</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md2766"></a>
options</h4>
<ul>
<li><a href="#tailable">tailable</a> *</li>
<li><a href="#sort">sort</a> *</li>
<li><a href="#limit">limit</a> *</li>
<li><a href="#skip">skip</a> *</li>
<li><a href="#maxscan">maxScan</a> *</li>
<li><a href="#maxtime">maxTime</a> *</li>
<li><a href="#batchSize">batchSize</a> *</li>
<li><a href="#comment">comment</a> *</li>
<li><a href="#snapshot">snapshot</a> *</li>
<li><a href="#hint">hint</a> *</li>
<li><a href="#slaveOk">slaveOk</a> *</li>
<li><a href="http://docs.mongodb.org/manual/reference/write-concern/">safe</a>: Boolean - passed through to the collection. Setting to <code>true</code> is equivalent to <code>{ w: 1 }</code></li>
<li><a href="#collection">collection</a>: the collection to query against</li>
</ul>
<p><em>* denotes a query helper method is also available</em></p>
<h2><a class="anchor" id="autotoc_md2767"></a>
setTraceFunction(func)</h2>
<p>Set a function to trace this query. Useful for profiling or logging.</p>
<div class="fragment"><div class="line">function traceFunction (method, queryInfo, query) {</div>
<div class="line">  console.log(&#39;starting &#39; + method + &#39; query&#39;);</div>
<div class="line"> </div>
<div class="line">  return function (err, result, millis) {</div>
<div class="line">    console.log(&#39;finished &#39; + method + &#39; query in &#39; + millis + &#39;ms&#39;);</div>
<div class="line">  };</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">mquery().setTraceFunction(traceFunction).findOne({name: &#39;Joe&#39;}, cb);</div>
</div><!-- fragment --><p>The trace function is passed (method, queryInfo, query)</p>
<ul>
<li>method is the name of the method being called (e.g. findOne)</li>
<li>queryInfo contains information about the query:<ul>
<li>conditions: query conditions/criteria</li>
<li>options: options such as sort, fields, etc</li>
<li>doc: document being updated</li>
</ul>
</li>
<li>query is the query object</li>
</ul>
<p>The trace function should return a callback function which accepts:</p><ul>
<li>err: error, if any</li>
<li>result: result, if any</li>
<li>millis: time spent waiting for query result</li>
</ul>
<p>NOTE: stream requests are not traced.</p>
<h2><a class="anchor" id="autotoc_md2768"></a>
mquery.setGlobalTraceFunction(func)</h2>
<p>Similar to <code>setTraceFunction()</code> but automatically applied to all queries.</p>
<div class="fragment"><div class="line">mquery.setTraceFunction(traceFunction);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2769"></a>
mquery.canMerge(conditions)</h2>
<p>Determines if <code>conditions</code> can be merged using <code>mquery().<a class="el" href="_m_i_t-_l_i_c_e_n_s_e_8txt.html#a17d7c1b7b1269ec7b0de0be59f09c44a">merge()</a></code>.</p>
<div class="fragment"><div class="line">var query = mquery({ type: &#39;drum&#39; });</div>
<div class="line">var okToMerge = mquery.canMerge(anObject)</div>
<div class="line">if (okToMerge) {</div>
<div class="line">  query.merge(anObject);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2770"></a>
mquery.use$geoWithin</h1>
<p>MongoDB 2.4 introduced the <code>$geoWithin</code> operator which replaces and is 100% backward compatible with <code>$within</code>. As of mquery 0.2, we default to using <code>$geoWithin</code> for all <code>within()</code> calls.</p>
<p>If you are running MongoDB &lt; 2.4 this will be problematic. To force <code>mquery</code> to be backward compatible and always use <code>$within</code>, set the <code>mquery.use$geoWithin</code> flag to <code>false</code>.</p>
<div class="fragment"><div class="line">mquery.use$geoWithin = false;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2771"></a>
Custom Base Queries</h1>
<p>Often times we want custom base queries that encapsulate predefined criteria. With <code>mquery</code> this is easy. First create the query you want to reuse and call its <code>toConstructor()</code> method which returns a new subclass of <code>mquery</code> that retains all options and criteria of the original.</p>
<div class="fragment"><div class="line">var greatMovies = mquery(movieCollection).where(&#39;rating&#39;).gte(4.5).toConstructor();</div>
<div class="line"> </div>
<div class="line">// use it!</div>
<div class="line">greatMovies().count(function (err, n) {</div>
<div class="line">  console.log(&#39;There are %d great movies&#39;, n);</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">greatMovies().where({ name: /^Life/ }).select(&#39;name&#39;).find(function (err, docs) {</div>
<div class="line">  console.log(docs);</div>
<div class="line">});</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2772"></a>
Validation</h1>
<p>Method and options combinations are checked for validity at runtime to prevent creation of invalid query constructs. For example, a <code>distinct</code> query does not support specifying options like <code>hint</code> or field selection. In this case an error will be thrown so you can catch these mistakes in development.</p>
<h1><a class="anchor" id="autotoc_md2773"></a>
Debug support</h1>
<p>Debug mode is provided through the use of the <a href="https://github.com/visionmedia/debug">debug</a> module. To enable: </p><pre class="fragment">DEBUG=mquery node yourprogram.js
</pre><p>Read the debug module documentation for more details.</p>
<h1><a class="anchor" id="autotoc_md2774"></a>
General compatibility</h1>
<h3><a class="anchor" id="autotoc_md2775"></a>
ObjectIds</h3>
<p><code>mquery</code> clones query arguments before passing them to a <code>collection</code> method for execution. This prevents accidental side-affects to the objects you pass. To clone <code>ObjectIds</code> we need to make some assumptions.</p>
<p>First, to check if an object is an <code>ObjectId</code>, we check its constructors name. If it matches either <code>ObjectId</code> or <code>ObjectID</code> we clone it.</p>
<p>To clone <code>ObjectIds</code>, we call its optional <code>clone</code> method. If a <code>clone</code> method does not exist, we fall back to calling <code>new obj.constructor(obj.id)</code>. We assume, for compatibility with the Node.js driver, that the <code>ObjectId</code> instance has a public <code>id</code> property and that when creating an <code>ObjectId</code> instance we can pass that <code>id</code> as an argument.</p>
<h3><a class="anchor" id="autotoc_md2776"></a>
Read Preferences</h3>
<p><code>mquery</code> supports specifying [Read Preferences]() to control from which MongoDB node your query will read. The Read Preferences spec also support specifying tags. To pass tags, some drivers (Node.js driver) require passing a special constructor that handles both the read preference and its tags. If you need to specify tags, pass an instance of your drivers ReadPreference constructor or roll your own. <code>mquery</code> will store whatever you provide and pass later to your collection during execution.</p>
<h1><a class="anchor" id="autotoc_md2777"></a>
Future goals</h1>
<ul>
<li>mongo shell compatibility</li>
<li>browser compatibility</li>
</ul>
<h1><a class="anchor" id="autotoc_md2778"></a>
Installation</h1>
<pre class="fragment">$ npm install mquery
</pre><h1><a class="anchor" id="autotoc_md2779"></a>
License</h1>
<p><a href="https://github.com/aheckmann/mquery/blob/master/LICENSE">MIT</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
